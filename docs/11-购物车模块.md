# ä¿®å¤bug

ï¼ˆ1ï¼‰å•†å“é¡µè·³è½¬åˆ°åˆ«çš„é¡µé¢ä¼šæŠ¥é”™ï¼Œï¼Œï¼Œåˆ¤æ–­åªæœ‰åœ¨å•†å“è¯¦æƒ…çš„æ—¶å€™ï¼Œæ‰å‘é€è¯·æ±‚

```ts
watchEffect(() => {
  const id = route.params.id as string
  if (route.fullPath === `/goods/${id}`) {
    // è·å–å•†å“ä¿¡æ¯
    goods.getGoodsInfo(id)
  }
})
```

ï¼ˆ2ï¼‰å•†å“é¡µè·³è½¬åˆ°å•†å“é¡µï¼Œï¼Œï¼Œè§„æ ¼çš„æ•°æ®è·å–è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„æ•°æ®ï¼ˆè„æ•°æ®ï¼‰ï¼Œå¯¼è‡´ç¦ç”¨æœ‰bugçš„

è·¯ç”±åˆ‡æ¢çš„æ—¶å€™ï¼Œé”€æ¯goods.vueç»„ä»¶

```ts
<div class="app-body">
  <!-- 
    è·¯ç”±å‡ºå£
    diffç®—æ³•  å¯¹æ¯”å‰åçš„keyå±æ€§ï¼Œå¦‚æœkeyå±æ€§å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ä¼šå¤ç”¨
    -->
  <RouterView :key="$route.fullPath"></RouterView>
</div>
```

ç»„ä»¶è™½ç„¶é”€æ¯äº†ï¼Œä½†æ˜¯piniaè¿˜æœ‰ä¸Šä¸€æ¬¡çš„å•†å“æ•°æ®ï¼Œå½“goodsç»„ä»¶é”€æ¯çš„æ—¶å€™ï¼ŒæŠŠpiniaçš„æ•°æ®é‡ç½®å³å¯

```ts
onUnmounted(() => {
  // console.log('goodsç»„ä»¶é”€æ¯äº†')
  // console.log(goods)
  // å½“ç»„ä»¶é”€æ¯çš„æ—¶å€™ï¼Œé‡ç½®goodsçš„æ•°æ®
  goods.$reset()
})
```

# è´­ç‰©è½¦æ¨¡å—

## è´­ç‰©è½¦åŠŸèƒ½åˆ†æ

![image-20220226233037218](docs/media/image-20220226233037218.png)

**æ€è·¯æµç¨‹**

1. è´­ç‰©è½¦çš„å„ç§æ“ä½œéƒ½ä¼šæœ‰ä¸¤ç§çŠ¶æ€çš„åŒºåˆ†ï¼Œç™»å½•å’Œæœªç™»å½•
2. æ‰€æœ‰æ“ä½œéƒ½å°è£…åˆ° `Pinia` ä¸­ï¼Œç»„ä»¶åªéœ€è¦è§¦å‘ `actions` å‡½æ•°
3. åœ¨actionsä¸­é€šè¿‡userä¿¡æ¯å»åŒºåˆ†ç™»å½•çŠ¶æ€
   1. å·²ç™»å½•ï¼Œé€šè¿‡è°ƒç”¨æ¥å£å»æœåŠ¡ç«¯æ“ä½œï¼Œå“åº”æˆåŠŸä¼šé€šè¿‡ `actions` ä¿®æ”¹ `Pinia` ä¸­çš„æ•°æ®å³å¯
   2. æœªç™»å½•æ—¶ï¼Œé€šè¿‡ `actions` ä¿®æ”¹ `Pinia` ä¸­çš„æ•°æ®å³å¯ï¼Œ `Pinia` å®ç°æŒä¹…åŒ–ï¼ŒåŒæ­¥ä¿å­˜åœ¨æœ¬åœ°

# é¦–é¡µè´­ç‰©è½¦-å·²ç™»å½•

## å‡†å¤‡è´­ç‰©è½¦ Store

> æœ¬èŠ‚ç›®æ ‡ï¼šä¸ºè´­ç‰©è½¦ä¸šåŠ¡å®šä¹‰ä¸“å±çš„ Storeï¼Œå¤šä¸ªç»„ä»¶éƒ½è¦ç”¨åˆ°è´­ç‰©è½¦æ•°æ®ã€‚

Pinia åŸºæœ¬ç»“æ„

```ts
import { defineStore } from "pinia";

const useCartStore = defineStore({
  id: "cart",
  // çŠ¶æ€
  state: () => ({
    // è´­ç‰©è½¦åˆ—è¡¨
    list: [],
  }),
  // è®¡ç®—
  getters: {},
  // æ–¹æ³•
  actions: {},
});

export default useCartStore;
```

`src\store\index.ts` åˆå¹¶æ–° `Store`

```ts
import useCategoryStore from './modules/category'
import useHomeStore from './modules/home'
import useGoodsStore from './modules/goods'
import useUserStore from './modules/user'
import useCartStore from './modules/cart'
export default function useStore() {
  return {
    category: useCategoryStore(),
    home: useHomeStore(),
    goods: useGoodsStore(),
    user: useUserStore(),
    cart: useCartStore()
  }
}

```

## åŠ å…¥è´­ç‰©è½¦-æ ¡éªŒ

ï¼ˆ1ï¼‰ç»™åŠ å…¥è´­ç‰©è½¦æŒ‰é’®æ³¨å†Œç‚¹å‡»äº‹ä»¶

```js
<XtxButton type="primary" style="margin-top:20px;" @click="addCart">
  åŠ å…¥è´­ç‰©è½¦
</XtxButton>

const addCart = () => {
  console.log('æ·»åŠ è´­ç‰©è½¦')
  // åˆ¤æ–­æ˜¯å¦æ˜¯å®Œæ•´çš„sku
}
```

ï¼ˆ2ï¼‰ä¿®æ”¹goods-skusç»„ä»¶ï¼Œå½“å…¨é€‰äº†å°±ä¼ é€’å¯¹åº”çš„skuId

```jsx
if (selected.length === props.goods.specs.length) {
  // 2. å»pathMapæ‰¾åˆ°å¯¹åº”çš„skuid
  const key = selected.join('â˜…')
  const [skuId] = pathMap[key]
  // 3. å­ä¼ çˆ¶ï¼Œç»™çˆ¶ç»„ä»¶
  emit('changeSku', skuId)
} else {
  emit('changeSku', '')
}
```

ï¼ˆ3ï¼‰ä¿®æ”¹changeSkué€»è¾‘ï¼Œè®°å½•é€‰ä¸­çš„sku

```jsx
// ä¿å­˜skuId
const currentSkuId = ref('')
const changeSku = (skuId: string) => {
  // console.log(skuId)
  // 1. æ ¹æ®æ¥æ”¶åˆ°çš„skuIdæ‰¾åˆ°å¯¹åº”çš„sku
  // 2. ä¿®æ”¹å•†å“çš„ä»·é’±åº“å­˜
  currentSkuId.value = skuId
  const sku = info.value.skus.find((item) => item.id === skuId)
  if (sku) {
    info.value.price = sku.price
    info.value.oldPrice = sku.oldPrice
    info.value.inventory = sku.inventory
  }
}
```

ï¼ˆ4ï¼‰åˆ¤æ–­skuæ˜¯å¦å®Œæ•´

```js
const addCart = () => {
  // åˆ¤æ–­æ˜¯å¦æ˜¯å®Œæ•´çš„sku
  if (!currentSkuId.value) {
    return Message.warning('è¯·é€‰æ‹©å®Œæ•´ä¿¡æ¯')
  }
  console.log('åŠ å…¥è´­ç‰©è½¦')
}
```

##  åŠ å…¥è´­ç‰©è½¦

> æœ¬èŠ‚ç›®æ ‡: å®Œæˆå•†å“è¯¦æƒ…çš„æ·»åŠ è´­ç‰©è½¦æ“ä½œã€‚

![image-20220227200120916](docs/media/image-20220227200120916.png)

**å®ç°æ­¥éª¤**

1. `actions` ä¸­å°è£…åŠ å…¥è´­ç‰©è½¦çš„æ¥å£ã€‚
2. åœ¨å•†å“è¯¦æƒ…é¡µå®ç°æ·»åŠ é€»è¾‘è§¦å‘ `actions` å‡½æ•°è°ƒç”¨æ¥å£ã€‚

****

**æ ¸å¿ƒä»£ç **

ï¼ˆ1ï¼‰å°è£…actions

```ts
// æ–¹æ³•
actions: {
  async addCart(data: { skuId: string; count: number }) {
    await request.post('/member/cart', data)
  }
}
```

ï¼ˆ2ï¼‰ ç‚¹å‡»æŒ‰é’®è°ƒç”¨æ¥å£

```ts
const count = ref(1)
const addCart = () => {
  // åˆ¤æ–­æ˜¯å¦æ˜¯å®Œæ•´çš„sku
  if (!currentSkuId.value) {
    return Message.warning('è¯·é€‰æ‹©å®Œæ•´ä¿¡æ¯')
  }
  cart.addCart({
    skuId: currentSkuId.value,
    count: count.value
  })
}
```

##  å¤´éƒ¨è´­ç‰©è½¦-åŸºæœ¬ç»“æ„

`æœ¬èŠ‚ç›®æ ‡:` åœ¨ç½‘ç«™å¤´éƒ¨è´­ç‰©è½¦å›¾ç‰‡å¤„ï¼Œé¼ æ ‡ç»è¿‡å±•ç¤ºè´­ç‰©è½¦åˆ—è¡¨

**ä»£ç è½åœ°**

1ï¼‰æ–°å»ºå¤´éƒ¨è´­ç‰©è½¦ç»„ä»¶ `src/views/layout/components/app-header-cart.vue`

```vue
<script setup lang="ts" name="AppHeaderCart"></script>

<template>
  <div class="cart">
    <a class="curr" href="javascript:;">
      <i class="iconfont icon-cart"></i><em>2</em>
    </a>
    <div class="layer">
      <div class="list">
        <div class="item" v-for="i in 4" :key="i">
          <RouterLink to="">
            <img
              src="https://yanxuan-item.nosdn.127.net/ead73130f3dbdb3cabe1c7b0f4fd3d28.png"
              alt=""
            />
            <div class="center">
              <p class="name ellipsis-2">
                å’Œæ‰‹è¶³å¹²è£‚è¯´æ‹œæ‹œ ingramsæ‰‹è¶³çš²è£‚ä¿®å¤éœœ
              </p>
              <p class="attr ellipsis">é¢œè‰²ï¼šä¿®å¤ç»¿ç“¶ å®¹é‡ï¼š150ml</p>
            </div>
            <div class="right">
              <p class="price">&yen;45.00</p>
              <p class="count">x2</p>
            </div>
          </RouterLink>
          <i class="iconfont icon-close-new"></i>
        </div>
      </div>
      <div class="foot">
        <div class="total">
          <p>å…± 3 ä»¶å•†å“</p>
          <p>&yen;135.00</p>
        </div>
        <XtxButton type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
.cart {
  width: 50px;
  position: relative;
  z-index: 600;
  .curr {
    height: 32px;
    line-height: 32px;
    text-align: center;
    position: relative;
    display: block;
    .icon-cart {
      font-size: 22px;
    }
    em {
      font-style: normal;
      position: absolute;
      right: 0;
      top: 0;
      padding: 1px 6px;
      line-height: 1;
      background: @helpColor;
      color: #fff;
      font-size: 12px;
      border-radius: 10px;
      font-family: Arial;
    }
  }
  &:hover {
    .layer {
      opacity: 1;
      transform: none;
    }
  }
  .layer {
    opacity: 0;
    transition: all 0.2s 0.1s;
    transform: translateY(-200px) scale(1, 0);
    width: 400px;
    height: 400px;
    position: absolute;
    top: 50px;
    right: 0;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    background: #fff;
    border-radius: 4px;
    padding-top: 10px;
    &::before {
      content: '';
      position: absolute;
      right: 14px;
      top: -10px;
      width: 20px;
      height: 20px;
      background: #fff;
      transform: scale(0.6, 1) rotate(45deg);
      box-shadow: -3px -3px 5px rgba(0, 0, 0, 0.1);
    }
    .foot {
      position: absolute;
      left: 0;
      bottom: 0;
      height: 70px;
      width: 100%;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      background: #f8f8f8;
      align-items: center;
      .total {
        padding-left: 10px;
        color: #999;
        p {
          &:last-child {
            font-size: 18px;
            color: @priceColor;
          }
        }
      }
    }
  }
  .list {
    height: 310px;
    overflow: auto;
    padding: 0 10px;
    &::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    &::-webkit-scrollbar-track {
      background: #f8f8f8;
      border-radius: 2px;
    }
    &::-webkit-scrollbar-thumb {
      background: #eee;
      border-radius: 10px;
    }
    &::-webkit-scrollbar-thumb:hover {
      background: #ccc;
    }
    .item {
      border-bottom: 1px solid #f5f5f5;
      padding: 10px 0;
      position: relative;
      i {
        position: absolute;
        bottom: 38px;
        right: 0;
        opacity: 0;
        color: #666;
        transition: all 0.5s;
      }
      &:hover {
        i {
          opacity: 1;
          cursor: pointer;
        }
      }
      a {
        display: flex;
        align-items: center;
        img {
          height: 80px;
          width: 80px;
        }
        .center {
          padding: 0 10px;
          width: 200px;
          .name {
            font-size: 16px;
          }
          .attr {
            color: #999;
            padding-top: 5px;
          }
        }
        .right {
          width: 100px;
          padding-right: 20px;
          text-align: center;
          .price {
            font-size: 16px;
            color: @priceColor;
          }
          .count {
            color: #999;
            margin-top: 5px;
            font-size: 16px;
          }
        }
      }
    }
  }
}
</style>

```

2ï¼‰headerç»„ä»¶ä½¿ç”¨è´­ç‰©è½¦ç»„ä»¶ `src/views/Layout/components/app-header.vue`

```diff
<script lang="ts" setup name="AppHeader">
import AppHeaderNav from './app-header-nav.vue'
+import AppHeaderCart from './app-header-cart.vue'
</script>

<template>
  <header class="app-header">
    <div class="container">
      <h1 class="logo">
        <RouterLink to="/">å°å…”é²œ</RouterLink>
      </h1>
      <AppHeaderNav />
      <div class="search">
        <i class="iconfont icon-search"></i>
        <input type="text" placeholder="æœä¸€æœ" />
      </div>
-      <div class="cart">
-        <a class="curr" href="#">
-          <i class="iconfont icon-cart"></i>
-          <em>2</em>
-        </a>
-      </div>  
+      <!-- è´­ç‰©è½¦ -->
+      <AppHeaderCart />
    </div>
  </header>
</template>
```

## å¤´éƒ¨è´­ç‰©è½¦æ¸²æŸ“

ï¼ˆ1ï¼‰æä¾›è´­ç‰©è½¦çš„æ•°æ®ç±»å‹`types/cart.d.ts`

```ts
// å•ä¸ªè´­ç‰©è½¦å•†å“
export interface CartItem {
  id: string
  skuId: string
  name: string
  attrsText: string
  picture: string
  price: string
  nowPrice: string
  nowOriginalPrice: string
  selected: boolean
  stock: number
  count: number
  isEffective: boolean
  // discount?: any;
  isCollect: boolean
  postFee: number
}

```

ï¼ˆ2ï¼‰æ–°å¢actionsï¼Œç”¨äºè·å–è´­ç‰©è½¦åˆ—è¡¨æ•°æ®

```ts
import request from '@/utils/request'
import { defineStore } from 'pinia'
import { CartItem } from '@/types/cart'
import { ApiRes } from '@/types/data'
const useCartStore = defineStore({
  id: 'cart',
  // çŠ¶æ€
  state: () => ({
    // è´­ç‰©è½¦åˆ—è¡¨
    list: [] as CartItem[]
  }),
  // æ–¹æ³•
  actions: {
    // è·å–è´­ç‰©è½¦åˆ—è¡¨
    async getCartList() {
      const res = await request.get<ApiRes<CartItem[]>>('/member/cart')
      this.list = res.data.result
    }
  }
})

export default useCartStore

```

ï¼ˆ3ï¼‰æä¾›è®¡ç®—å±æ€§

```ts
// è®¡ç®—
getters: {
  // è®¡ç®—æœ‰æ•ˆå•†å“åˆ—è¡¨ isEffective = true  filter
  effectiveList(): CartItem[] {
    return this.list.filter((item) => item.stock > 0 && item.isEffective)
  },
  // æœ‰æ•ˆå•†å“æ€»æ•°é‡ æŠŠeffctiveListä¸­çš„æ¯ä¸€é¡¹çš„countå åŠ èµ·æ¥
  effectiveListCounts(): number {
    return this.effectiveList.reduce((sum, item) => sum + item.count, 0)
  },
  // æ€»é’±æ•°  = æ‰€æœ‰å•é¡¹çš„é’±æ•°ç´¯åŠ   å•é¡¹çš„é’±æ•° = æ•°é‡ * å•ä»·
  effectiveListPrice(): string {
    return this.effectiveList
      .reduce((sum, item) => sum + item.count * Number(item.nowPrice), 0)
      .toFixed(2)
  }
},
```

ï¼ˆ4ï¼‰æ¸²æŸ“å¤´éƒ¨è´­ç‰©è½¦

```vue
<script setup lang="ts" name="AppHeaderCart">
import useStore from '@/store'

const { cart } = useStore()
cart.getCartList()
</script>

<template>
  <div class="cart">
    <a class="curr" href="javascript:;">
      <i class="iconfont icon-cart"></i><em>{{ cart.effectiveListCounts }}</em>
    </a>
    <div class="layer">
      <div class="list">
        <div class="item" v-for="item in cart.effectiveList" :key="item.skuId">
          <RouterLink :to="`/goods/${item.id}`">
            <img :src="item.picture" alt="" />
            <div class="center">
              <p class="name ellipsis-2">
                {{ item.name }}
              </p>
              <p class="attr ellipsis">{{ item.attrsText }}</p>
            </div>
            <div class="right">
              <p class="price">&yen;{{ item.price }}</p>
              <p class="count">x{{ item.count }}</p>
            </div>
          </RouterLink>
          <i class="iconfont icon-close-new"></i>
        </div>
      </div>
      <div class="foot">
        <div class="total">
          <p>å…± {{ cart.effectiveListCounts }} ä»¶å•†å“</p>
          <p>&yen;{{ cart.effectiveListPrice }}</p>
        </div>
        <XtxButton type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
      </div>
    </div>
  </div>
</template>
```

## ä¼˜åŒ–-åŠ å…¥è´­ç‰©è½¦

ï¼ˆ1ï¼‰å‘é€è¯·æ±‚æ·»åŠ æˆåŠŸåï¼Œéœ€è¦é‡æ–°æ¸²æŸ“

```ts
// æ·»åŠ è´­ç‰©è½¦
async addCart(skuId: string, count: number) {
  await request.post('/member/cart', {
    skuId,
    count,
  })
  // é‡æ–°è·å–è´­ç‰©è½¦æ•°æ®
  this.getCartList()
},
```

ï¼ˆ2ï¼‰æç¤ºæ¶ˆæ¯

```ts
const addCart = async () => {
  if (!currentSkuId) {
    return Message.warning('è¯·é€‰æ‹©å®Œæ•´çš„å•†å“ä¿¡æ¯')
  }
  await cart.addCart(currentSkuId, count.value)
  Message.success('æ·»åŠ æˆåŠŸ')
}
```



## åˆ é™¤åŠŸèƒ½å®ç°

**å®ç°æ­¥éª¤**

1. ç¼–å†™actionsè¿›è¡Œåˆ é™¤æ“ä½œ
2. åœ¨å¤´éƒ¨è´­ç‰©è½¦è¿›è¡Œactionè°ƒç”¨

**ä»£ç è½åœ°**

1ï¼‰ Pinia çš„actionsä»£ç  `src/store/modules/cart.ts`

```ts
// åˆ é™¤è´­ç‰©è½¦å•†å“
async deleteCart(skuIds: string[]) {
  await request.delete('/member/cart', {
    data: { ids: skuIds }
  })
  // é‡æ–°è·å–æœ€æ–°è´­ç‰©è½¦åˆ—è¡¨
  this.getCartList()
}
```

ï¼ˆ2ï¼‰æ³¨å†Œäº‹ä»¶

```ts
<i
  class="iconfont icon-close-new"
  @click="cart.delCart([item.skuId])"
></i>
```

3ï¼‰å°ä¼˜åŒ–

> è´­ç‰©è½¦æ²¡æœ‰æ•°æ®çš„æ—¶å€™æˆ–è€…å½“å‰é¡µå°±åœ¨è´­ç‰©è½¦é¡µé¢ï¼Œä¸æ˜¾ç¤ºç§»å…¥é¼ æ ‡æ•ˆæœ

```vue
<div class="layer" v-if="cart.effectiveList.length && $route.path !== '/cart'">
```

# ç¡®è®¤æ¡†ç»„ä»¶å°è£…

> ç›®æ ‡å°è£…ä¸€ä¸ªconfirmå¼¹å‡ºç¡®è®¤æ¡†

![image-20220227220604125](docs/media/image-20220227220604125.png)

å¤§è‡´æ­¥éª¤ï¼š

- å®ç°ç»„ä»¶åŸºç¡€ç»“æ„å’Œæ ·å¼ã€‚
- å®ç°å‡½æ•°å¼è°ƒç”¨ç»„ä»¶æ–¹å¼å’Œå®Œæˆäº¤äº’ã€‚
- åŠ ä¸Šæ‰“å¼€æ—¶åŠ¨ç”»æ•ˆæœã€‚
- åŸºäºPromiseè¿›è¡Œå°è£…
- ç»™é€€å‡ºåŠŸèƒ½åŠ ä¸Šç¡®è®¤æ¡†ã€‚

## åŸºæœ¬ç»“æ„

ï¼ˆ1ï¼‰æ–°å»ºæ–‡ä»¶`src/components/confirm/confirm.vue`

```vue
<script lang="ts" setup name="XtxConfirm"></script>
<template>
  <div class="xtx-confirm">
    <div class="wrapper">
      <div class="header">
        <h3>æ¸©é¦¨æç¤º</h3>
        <a href="JavaScript:;" class="iconfont icon-close-new"></a>
      </div>
      <div class="body">
        <i class="iconfont icon-warning"></i>
        <span>æ‚¨ç¡®è®¤ä»è´­ç‰©è½¦åˆ é™¤è¯¥å•†å“å—ï¼Ÿ</span>
      </div>
      <div class="footer">
        <XtxButton size="mini" type="gray">å–æ¶ˆ</XtxButton>
        <XtxButton size="mini" type="primary">ç¡®è®¤</XtxButton>
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
.xtx-confirm {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  z-index: 8888;
  background: rgba(0, 0, 0, 0.5);
  .wrapper {
    width: 400px;
    background: #fff;
    border-radius: 4px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    .header,
    .footer {
      height: 50px;
      line-height: 50px;
      padding: 0 20px;
    }
    .body {
      padding: 20px 40px;
      font-size: 16px;
      .icon-warning {
        color: @priceColor;
        margin-right: 3px;
        font-size: 16px;
      }
    }
    .footer {
      text-align: right;
      .xtx-button {
        margin-left: 20px;
      }
    }
    .header {
      position: relative;
      h3 {
        font-weight: normal;
        font-size: 18px;
      }
      a {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 20px;
        width: 20px;
        height: 20px;
        line-height: 20px;
        text-align: center;
        color: #999;
        &:hover {
          color: #666;
        }
      }
    }
  }
}
</style>

```

ï¼ˆ2ï¼‰åœ¨playgroundä¸­æµ‹è¯•

```ts
<script lang="ts" setup name="PlayGround">
import Confirm from '@/components/confirm/confirm.vue'
</script>

<template>
  <Confirm></Confirm>
</template>

<style scoped lang="less"></style>
```

ï¼ˆ1ï¼‰propså¤„ç†

```ts
<script lang="ts" setup name="XtxConfirm">
defineProps({
  title: {
    type: String,
    default: '',
  },
  text: {
    type: String,
    required: true,
  },
})
</script>
```

## å°è£…æˆå‡½æ•°-åŸºç¡€

æ–°å»ºæ–‡ä»¶`src/components/confirm/index.ts`ä¸­

```ts
import { h, render } from 'vue'
import XtxConfirm from './confirm.vue'
type Props = {
  text: string
  title?: string
}

const div = document.createElement('div')
div.setAttribute('class', 'xtx-confirm-container')
document.body.appendChild(div)
export default function Confirm({ text, title }: Props) {
  const vNode = h(XtxConfirm, { text, title })
  render(vNode, div)
}

```

åœ¨playgroundä¸­ä½¿ç”¨

```ts
<script lang="ts" setup name="PlayGround">
import Confirm from '@/components/confirm'

const show = () => {
  Confirm({
    text: 'ä½ ç¡®å®šè¦é€€å‡ºå—',
    title: 'æ¸©é¦¨æç¤º',
  })
}
</script>

<template>
  <button @click="show">æ˜¾ç¤º</button>
</template>

<style scoped lang="less"></style>

```



## å°è£…æˆå‡½æ•°-æŒ‰é’®æ ·å¼è¯´æ˜

> ç”±äºè¶…å‡ºäº†Appçš„èŒƒå›´ï¼Œå› æ­¤å…¨å±€ç»„ä»¶ä¸ç”Ÿæ•ˆ

```ts
<script lang="ts" setup name="XtxConfirm">
import XtxButton from '../button/index.vue'
</script>
```



## å°è£…æˆå‡½æ•°-ç»„ä»¶äº¤äº’

![image-20220227222408933](docs/media/image-20220227222408933.png)





ï¼ˆ2ï¼‰ä¿®æ”¹å‡½æ•°

```ts
import { h, render } from 'vue'
import XtxConfirm from './confirm.vue'
type Props = {
  text: string
  title?: string
}

const div = document.createElement('div')
div.setAttribute('class', 'xtx-confirm-container')
document.body.appendChild(div)
export default function Confirm({ text, title }: Props) {
  return new Promise((resolve, reject) => {
    const confirmCallback = () => {
      render(null, div)
      resolve(undefined)
    }
    const cancelCallback = () => {
      render(null, div)
      reject(undefined)
    }
    const vNode = h(XtxConfirm, {
      title,
      text,
      confirmCallback,
      cancelCallback
    })
    render(vNode, div)
  })
}

```

ï¼ˆ2ï¼‰ä¿®æ”¹ç»„ä»¶

```ts
<script lang="ts" setup name="XtxConfirm">
import { onMounted, PropType, ref } from 'vue'

const props = defineProps({
  title: {
    type: String,
    default: 'æ¸©é¦¨æç¤º'
  },
  text: {
    type: String,
    default: ''
  },
  confirmCallback: {
    type: Function as PropType<() => void>
  },
  cancelCallback: {
    type: Function as PropType<() => void>
  }
})
</script>
<template>
  <div class="xtx-confirm">
    <div class="wrapper">
      <div class="header">
        <h3>{{ title }}</h3>
        <a
          href="JavaScript:;"
          class="iconfont icon-close-new"
          @click="cancelCallback"
        ></a>
      </div>
      <div class="body">
        <i class="iconfont icon-warning"></i>
        <span>{{ text }}</span>
      </div>
      <div class="footer">
        <XtxButton size="mini" type="gray" @click="cancelCallback">
          å–æ¶ˆ
        </XtxButton>
        <XtxButton size="mini" type="primary" @click="confirmCallback">
          ç¡®è®¤
        </XtxButton>
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
.xtx-confirm {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  z-index: 8888;
  background: rgba(0, 0, 0, 0.5);
  .wrapper {
    width: 400px;
    background: #fff;
    border-radius: 4px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    .header,
    .footer {
      height: 50px;
      line-height: 50px;
      padding: 0 20px;
    }
    .body {
      padding: 20px 40px;
      font-size: 16px;
      .icon-warning {
        color: @priceColor;
        margin-right: 3px;
        font-size: 16px;
      }
    }
    .footer {
      text-align: right;
      .xtx-button {
        margin-left: 20px;
      }
    }
    .header {
      position: relative;
      h3 {
        font-weight: normal;
        font-size: 18px;
      }
      a {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 20px;
        width: 20px;
        height: 20px;
        line-height: 20px;
        text-align: center;
        color: #999;
        &:hover {
          color: #666;
        }
      }
    }
  }
}
</style>

```

ï¼ˆ3ï¼‰ä½¿ç”¨

```ts
<script lang="ts" setup name="PlayGround">
import Confirm from '@/components/confirm'
const show = () => {
  Confirm({
    title: 'æ¸©é¦¨æç¤º',
    text: 'ä½ ç¡®å®šè¦åˆ é™¤'
  })
    .then(() => {
      console.log('ç‚¹å‡»äº†ç¡®å®š')
    })
    .catch(() => {
      console.log('ç‚¹å‡»äº†å–æ¶ˆ')
    })
}
</script>
```

## åŠ¨ç”»å¤„ç†

ï¼ˆ1ï¼‰ä¿®æ”¹æ ·å¼

```diff
.xtx-confirm {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  z-index: 8888;
+  background: rgba(0,0,0,0);
+  &.fade {
+    transition: all 0.4s;
+    background: rgba(0,0,0,.5);
+  }
  .wrapper {
    width: 400px;
    background: #fff;
    border-radius: 4px;
    position: absolute;
    top: 50%;
    left: 50%;
+    transform: translate(-50%,-60%);
+    opacity: 0;
+    &.fade {
+      transition: all 0.4s;
+      transform: translate(-50%,-50%);
+      opacity: 1;
+    }
```

æ·»åŠ ç±»å

```vue
  <div class="xtx-confirm" :class="{ fade: show }">
    <div class="wrapper" :class="{ fade: show }">
```

æ·»åŠ å®šæ—¶å™¨ï¼Œæ‰ä¼šæœ‰åŠ¨ç”»æ•ˆæœ

```ts
const show = ref(false)
onMounted(() => {
  setTimeout(() => {
    show.value = true
  }, 20)
})
```

## é€€å‡ºç™»å½•æ—¶ä¼˜åŒ–

```ts
const delCart = async (skuId: string) => {
  await Confirm({
    title: 'æ¸©é¦¨æç¤º',
    text: 'ä½ ç¡®å®šè¦åˆ é™¤å—'
  })
  cart.deleteCart([skuId])
}
```



# è´­ç‰©è½¦é¡µé¢-å·²ç™»å½•

##  è´­ç‰©è½¦é¡µé¢-è·¯ç”±ä¸åŸºæœ¬ç»“æ„

> `æœ¬èŠ‚ç›®æ ‡:` å®Œæˆè´­ç‰©è½¦ç»„ä»¶åŸºç¡€å¸ƒå±€å’Œè·¯ç”±é…ç½®ä¸è·³è½¬é“¾æ¥

![image-20220227204058941](docs/media/image-20220227204058941.png)

1ï¼‰æ–°å»ºè´­ç‰©è½¦é¡µé¢ç»„ä»¶ `src/views/cart/index.vue`

```vue
<script setup lang="ts" name="Cart">
//
</script>

<template>
  <div class="xtx-cart-page">
    <div class="container">
      <XtxBread>
        <XtxBreadItem to="/">é¦–é¡µ</XtxBreadItem>
        <XtxBreadItem>è´­ç‰©è½¦</XtxBreadItem>
      </XtxBread>
      <div class="cart">
        <table>
          <thead>
            <tr>
              <th width="120"><XtxCheckbox>å…¨é€‰</XtxCheckbox></th>
              <th width="400">å•†å“ä¿¡æ¯</th>
              <th width="220">å•ä»·</th>
              <th width="180">æ•°é‡</th>
              <th width="180">å°è®¡</th>
              <th width="140">æ“ä½œ</th>
            </tr>
          </thead>
          <!-- æœ‰æ•ˆå•†å“ -->
          <tbody>
            <tr v-for="i in 3" :key="i">
              <td><XtxCheckbox /></td>
              <td>
                <div class="goods">
                  <RouterLink to="/">
                    <img
                      src="https://yanxuan-item.nosdn.127.net/13ab302f8f2c954d873f03be36f8fb03.png"
                      alt=""
                    />
                  </RouterLink>
                  <div>
                    <p class="name ellipsis">
                      å’Œæ‰‹è¶³å¹²è£‚è¯´æ‹œæ‹œ ingramsæ‰‹è¶³çš²è£‚ä¿®å¤éœœ
                    </p>
                    <p class="attr">å•†å“è§„æ ¼</p>
                  </div>
                </div>
              </td>
              <td class="tc">
                <p>&yen;200.00</p>
              </td>
              <td class="tc">
                <XtxNumbox :model-value="1" />
              </td>
              <td class="tc"><p class="f16 red">&yen;200.00</p></td>
              <td class="tc">
                <p><a href="javascript:;">ç§»å…¥æ”¶è—å¤¹</a></p>
                <p><a class="green" href="javascript:;">åˆ é™¤</a></p>
                <p><a href="javascript:;">æ‰¾ç›¸ä¼¼</a></p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- æ“ä½œæ  -->
      <div class="action">
        <div class="batch"></div>
        <div class="total">
          å…± 7 ä»¶æœ‰æ•ˆå•†å“ï¼Œå·²é€‰æ‹© 2 ä»¶ï¼Œå•†å“åˆè®¡ï¼š
          <span class="red">Â¥400</span>
          <XtxButton type="primary">ä¸‹å•ç»“ç®—</XtxButton>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
.tc {
  text-align: center;
  .xtx-numbox {
    margin: 0 auto;
    width: 120px;
  }
}
.red {
  color: @priceColor;
}
.green {
  color: @xtxColor;
}
.f16 {
  font-size: 16px;
}
.goods {
  display: flex;
  align-items: center;
  img {
    width: 100px;
    height: 100px;
  }
  > div {
    width: 280px;
    font-size: 16px;
    padding-left: 10px;
    .attr {
      font-size: 14px;
      color: #999;
    }
  }
}
.action {
  display: flex;
  background: #fff;
  margin-top: 20px;
  height: 80px;
  align-items: center;
  font-size: 16px;
  justify-content: space-between;
  padding: 0 30px;
  .xtx-checkbox {
    color: #999;
  }
  .batch {
    a {
      margin-left: 20px;
    }
  }
  .red {
    font-size: 18px;
    margin-right: 20px;
    font-weight: bold;
  }
}
.tit {
  color: #666;
  font-size: 16px;
  font-weight: normal;
  line-height: 50px;
}
.xtx-cart-page {
  .cart {
    background: #fff;
    color: #666;
    table {
      border-spacing: 0;
      border-collapse: collapse;
      line-height: 24px;
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #f5f5f5;
        &:first-child {
          text-align: left;
          padding-left: 30px;
          color: #999;
        }
      }
      th {
        font-size: 16px;
        font-weight: normal;
        line-height: 50px;
      }
    }
  }
}
</style>

```

2ï¼‰å‡†å¤‡è·¯ç”±

```ts
{
  path: '/cart',
  component: () => import('@/views/cart/index.vue')
}
```

ï¼ˆ3ï¼‰ç‚¹å‡»è´­ç‰©è½¦æŒ‰é’®è·³è½¬

```ts
<RouterLink to="/cart" class="curr">
  <i class="iconfont icon-cart"></i><em>{{ cart.effectiveListCounts }}</em>
</RouterLink>


<XtxButton @click="$router.push('/cart')" type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
```

## è´­ç‰©è½¦é¡µé¢-æ¸²æŸ“åˆ—è¡¨

> `æœ¬èŠ‚ç›®æ ‡:` å®ç°è´­ç‰©è½¦å•†å“åˆ—è¡¨å±•ç¤ºåŠŸèƒ½

```vue
<table>
  <thead>
    <tr>
      <th width="120"><XtxCheckbox>å…¨é€‰</XtxCheckbox></th>
      <th width="400">å•†å“ä¿¡æ¯</th>
      <th width="220">å•ä»·</th>
      <th width="180">æ•°é‡</th>
      <th width="180">å°è®¡</th>
      <th width="140">æ“ä½œ</th>
    </tr>
  </thead>
  <!-- æœ‰æ•ˆå•†å“ -->
  <tbody>
    <tr v-for="item in cart.list" :key="item.skuId">
      <td><XtxCheckbox :model-value="item.selected" /></td>
      <td>
        <div class="goods">
          <RouterLink :to="`/goods/${item.id}`">
            <img :src="item.picture" alt="" />
          </RouterLink>
          <div>
            <p class="name ellipsis">
              {{ item.name }}
            </p>
            <p class="attr">{{ item.attrsText }}</p>
          </div>
        </div>
      </td>
      <td class="tc">
        <p>&yen;{{ item.nowPrice }}</p>
      </td>
      <td class="tc">
        <XtxNumbox :model-value="item.count" :max="item.stock" />
      </td>
      <td class="tc">
        <p class="f16 red">
          &yen;{{ (Number(item.nowPrice) * item.count).toFixed(2) }}
        </p>
      </td>
      <td class="tc">
        <p><a href="javascript:;">ç§»å…¥æ”¶è—å¤¹</a></p>
        <p><a class="green" href="javascript:;">åˆ é™¤</a></p>
        <p><a href="javascript:;">æ‰¾ç›¸ä¼¼</a></p>
      </td>
    </tr>
  </tbody>
</table>
```

## è´­ç‰©è½¦é¡µé¢-åˆ é™¤æ“ä½œ

> `æœ¬èŠ‚ç›®æ ‡:` å®ç°å•†å“åˆ é™¤åŠŸèƒ½

**æ€è·¯åˆ†æ**

1. ç‚¹å‡»åˆ é™¤æŒ‰é’®è®°å½•å½“å‰ç‚¹å‡»çš„å•†å“ skuId
2. è°ƒç”¨ action å‡½æ•°å®ç°åˆ é™¤å³å¯ã€‚

**ä»£ç è½åœ°**

> åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶è§¦å‘åˆ é™¤actionå‡½æ•°

```ts
<p>
  <a
    @click="delCart([item.skuId])"
    class="green"
    href="javascript:;"
    >åˆ é™¤</a
  >
</p>


const delCart = async (skuIds: string[]) => {
  await Confirm({
    title: 'æ¸©é¦¨æç¤º',
    text: 'ä½ ç¡®å®šè¦åˆ é™¤å—?'
  })
  await cart.delCart(skuIds)
  Message.success('åˆ é™¤æˆåŠŸ')
}
```

åˆ é™¤å…‰è´­ç‰©è½¦ä¹‹åä½¿ç”¨å…ƒç´ å ä½

```vue
<!-- åˆ é™¤å…‰è´­ç‰©è½¦ä¹‹åä½¿ç”¨å…ƒç´ å ä½ -->
<tr v-if="cart.effectiveList.length === 0">
  <td colspan="6">
    <div class="cart-none" style="text-align: center">
      <img src="@/assets/images/none.png" alt="" />
      <p>è´­ç‰©è½¦å†…æš‚æ—¶æ²¡æœ‰å•†å“</p>
      <div class="btn" style="margin: 20px">
        <XtxButton type="primary"> ç»§ç»­é€›é€› </XtxButton>
      </div>
    </div>
  </td>
</tr>
```

## è´­ç‰©è½¦é¡µé¢-å•é€‰æ“ä½œ

`æœ¬èŠ‚ç›®æ ‡:` å®ç°çš„å•†å“å•é€‰åŠŸèƒ½

ä»å•é€‰å¼€å§‹ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°ä¸€ä¸ª `Pinia` + è¡¨å•æ•°æ®çš„äº¤äº’åŠŸèƒ½å®ç°

![image-20220227211742692](docs/media/image-20220227211742692.png)

ï¼ˆ1ï¼‰å°è£…ä¿®æ”¹å•†å“çš„æ¥å£

```ts
// ä¿®æ”¹è´­ç‰©è½¦å•†å“
async updateCart(
  skuId: string,
  data: { selected?: boolean; count?: number }
) {
  await request.put(`/member/cart/${skuId}`, data)
  // é‡æ–°è·å–æœ€æ–°è´­ç‰©è½¦åˆ—è¡¨
  this.getCartList()
}
```

ï¼ˆ2ï¼‰ç»„ä»¶ä¸­æ³¨å†Œç‚¹å‡»äº‹ä»¶

```vue
<script setup lang="ts" name="Cart">
import useStore from '@/store'

const { cart } = useStore()

const changeSelected = async (skuId: string, checked: boolean) => {
  await cart.updateCart(skuId, {
    selected: checked
  })
  Message.success('ä¿®æ”¹çŠ¶æ€æˆåŠŸ')
}
</script>

<td>
  <XtxCheckbox
    :model-value="item.selected"
    @update:modelValue="changeSelected(item.skuId, $event)"
  />
</td>
```

## è´­ç‰©è½¦é¡µé¢-ä¿®æ”¹æ•°é‡

ï¼ˆ1ï¼‰ç»‘å®šäº‹ä»¶è§¦å‘ action

```ts
const changeCount = (skuId: string, count: number) => {
  cart.updateCart(skuId, {
    count
  })
}

<td class="tc">
  <XtxNumbox
    :model-value="item.count"
    @update:model-value="changeCount(item.skuId, $event)"
    :max="item.stock"
  />
</td>
```

## è´­ç‰©è½¦é¡µé¢-å…¨é€‰åˆ‡æ¢å®ç°

ï¼ˆ1ï¼‰å°è£…æ¥å£

```ts
// è®¡ç®—
getters: {
  isAllSelected(): boolean {
    return (
      this.effectiveList.length !== 0 &&
      this.effectiveList.every((item) => item.selected)
    )
  }
},
    
// ä¿®æ”¹å…¨é€‰æˆ–è€…å…¨ä¸é€‰
async updateCartAllSelected(isSelected: boolean) {
  await request.put('/member/cart/selected', {
    selected: isSelected,
  })
  // è·å–è´­ç‰©è½¦åˆ—è¡¨
  this.getCartList()
},
```

ï¼ˆ2ï¼‰é¡µé¢ä¸­è°ƒç”¨

```vue
<XtxCheckbox
  :model-value="cart.isAllSelected"
  @update:model-value="
    cart.updateCartAllSelected(!cart.isAllSelected)
  "
>
  å…¨é€‰
</XtxCheckbox>
```

## è´­ç‰©è½¦é¡µé¢-æ“ä½œæ æ¸²æŸ“

ï¼ˆ1ï¼‰æä¾›è®¡ç®—å±æ€§

```ts
// è®¡ç®—
getters: {
  // å·²é€‰æ‹©çš„åˆ—è¡¨
  selectedList(): CartItem[] {
    return this.effectiveList.filter((item) => item.selected)
  },
  // å·²é€‰æ‹©çš„å•†å“æ€»æ•°
  selectedListCounts(): number {
    return this.selectedList.reduce((sum, item) => sum + item.count, 0)
  },
  // å·²é€‰æ‹©çš„åˆ—è¡¨æ€»ä»·
  selectedListPrice(): string {
    return this.selectedList
      .reduce((sum, item) => sum + item.count * Number(item.nowPrice), 0)
      .toFixed(2)
  }
},
```

ï¼ˆ2ï¼‰æ¸²æŸ“æ“ä½œæ 

```ts
<!-- æ“ä½œæ  -->
<div class="action">
  <div class="batch"></div>
  <div class="total">
    å…± {{ cart.effectiveListCounts }} ä»¶æœ‰æ•ˆå•†å“ï¼Œå·²é€‰æ‹©
    {{ cart.selectedListCounts }} ä»¶ï¼Œå•†å“åˆè®¡ï¼š
    <span class="red">Â¥{{ cart.selectedListPrice }}</span>
    <XtxButton type="primary">ä¸‹å•ç»“ç®—</XtxButton>
  </div>
</div>
```

## è´­ç‰©è½¦é¡µé¢-ä¿®æ”¹è§„æ ¼

> ç›®çš„ï¼šå°è£…ä¸€ä¸ªè´­ç‰©è½¦SKUç»„ä»¶ï¼Œæ¥ä¿®æ”¹è§„æ ¼ã€‚

![image-20220301212832340](docs/media/image-20220301212832340.png)

å¤§è‡´æ­¥éª¤ï¼š

- å®šä¹‰ä¸€ä¸ªç»„ä»¶å®ŒæˆåŸºç¡€ç»“æ„
- å®Œæˆå±•å¼€æ”¶èµ·æ“ä½œ
- å±•å¼€çš„æ—¶å€™æ ¹æ®skuIdå¾—åˆ°å•†å“ä¿¡æ¯ï¼ˆspecs,skusï¼‰æ¸²æŸ“å•†å“è§„æ ¼ã€‚
- é€‰æ‹©å®Œæ¯•åï¼Œç‚¹å‡»ç¡®è®¤åï¼Œä¿®æ”¹å½“å‰å•†å“è§„æ ¼ã€‚

### åŸºæœ¬ç»“æ„

ï¼ˆ1ï¼‰å®šä¹‰ä¸€ä¸ªç»„ä»¶å®ŒæˆåŸºç¡€ç»“æ„

å®šä¹‰ç»„ä»¶ `src/views/cart/components/cart-sku.vue`

```vue
<script name="CartSku" setup lang="ts"></script>

<template>
  <div class="cart-sku">
    <div class="attrs">
      <span class="ellipsis">é¢œè‰²ï¼šç²‰è‰² å°ºå¯¸ï¼š14cm äº§åœ°ï¼šä¸­å›½</span>
      <i class="iconfont icon-angle-down"></i>
    </div>
    <div class="layer">GoodsSku</div>
  </div>
</template>

<style scoped lang="less">
.cart-sku {
  height: 28px;
  border: 1px solid #f5f5f5;
  padding: 0 6px;
  position: relative;
  margin-top: 10px;
  display: inline-block;
  .attrs {
    line-height: 24px;
    display: flex;
    span {
      max-width: 230px;
      font-size: 14px;
      color: #999;
    }
    i {
      margin-left: 5px;
      font-size: 14px;
    }
  }
  .layer {
    position: absolute;
    left: -1px;
    top: 40px;
    z-index: 10;
    width: 400px;
    border: 1px solid @xtxColor;
    box-shadow: 2px 2px 4px lighten(@xtxColor, 50%);
    background: #fff;
    border-radius: 4px;
    font-size: 14px;
    padding: 20px;
    &::before {
      content: '';
      width: 12px;
      height: 12px;
      border-left: 1px solid @xtxColor;
      border-top: 1px solid @xtxColor;
      position: absolute;
      left: 12px;
      top: -8px;
      background: #fff;
      transform: scale(0.8, 1) rotate(45deg);
    }
  }
}
</style>

```

ä½¿ç”¨ç»„ä»¶ `src/views/cart/index.vue`

```ts
import CartSku from './components/cart-sku.vue'


<!-- å•†å“è§„æ ¼ -->
<CartSku></CartSku>
```

ï¼ˆ2ï¼‰å®Œæˆå±•å¼€æ”¶èµ·æ“ä½œ `src/views/cart/components/cart-sku.vue`

```vue
<script name="CartSku" setup lang="ts">
import { onClickOutside } from '@vueuse/core'
import { ref } from 'vue'

const visible = ref(false)
const toggle = () => {
  visible.value = !visible.value
}
const target = ref(null)
onClickOutside(target, () => {
  visible.value = false
})
</script>

<template>
  <div class="cart-sku" ref="target">
    <div class="attrs" @click="toggle">
      <span class="ellipsis">é¢œè‰²ï¼šç²‰è‰² å°ºå¯¸ï¼š14cm äº§åœ°ï¼šä¸­å›½</span>
      <i class="iconfont icon-angle-down"></i>
    </div>
    <div class="layer" v-if="visible">
        GoodsSku
    </div>
  </div>
</template>
```

- åŠ¨æ€æ¸²æŸ“æ–‡å­—

```jsx
defineProps({
  attrsText: {
    type: String,
    default: ''
  }
})


<span class="ellipsis">{{ attrsText }}</span>



// çˆ¶ç»„ä»¶
<!-- å•†å“è§„æ ¼ -->
<CartSku :attrsText="item.attrsText"></CartSku>
```

### æ¸²æŸ“è§„æ ¼

ï¼ˆ1ï¼‰ä½¿ç”¨ç»„ä»¶ä¼ äººskuId `src/views/cart/index.vue`

```html
<div>
    <p class="name ellipsis">{{item.name}}</p>
    <!-- é€‰æ‹©è§„æ ¼ç»„ä»¶ -->
    <CartSku attrs-text="item.attrsText" :skuId="item.skuId" />
</div>
```

ï¼ˆ2ï¼‰å­ç»„ä»¶æ¥æ”¶skuId

```js
<script name="CartSku" setup lang="ts">
const props = defineProps({
  attrsText: {
    type: String,
    default: ''
  },
  skuId: {
    type: String,
    default: ''
  }
})
</script>
```

ï¼ˆ3ï¼‰è¯·æ±‚è´­ç‰©è½¦æ•°æ®

```jsx

// è·å–å•†å“ä¿¡æ¯
const goods = ref({} as GoodsInfo)
onMounted(async () => {
  const res = await request.get<ApiRes<GoodsInfo>>(`/goods/sku/${props.skuId}`)
  goods.value = res.data.result
})
```

ï¼ˆ4ï¼‰æ¸²æŸ“GoodsSkuç»„ä»¶

```jsx
<div class="layer" v-if="visible">
  <GoodsSku :goods="goods" :sku-id="skuId"></GoodsSku>
</div>
```

ï¼ˆ5ï¼‰å¢åŠ ç¡®å®šæŒ‰é’®

```ts
<div class="layer" v-if="visible">
  <GoodsSku :goods="goods" :skuId="skuId"></GoodsSku>
    <XtxButton type="primary" size="mini" style="margin-left:60px">
        ç¡®è®¤
    </XtxButton>
</div>
```

### ä¿®æ”¹è§„æ ¼

- é€‰æ‹©å®Œæ¯•åï¼Œç‚¹å‡»ç¡®è®¤åï¼Œä¿®æ”¹å½“å‰å•†å“è§„æ ¼ã€‚

ï¼ˆ1ï¼‰ç»™goodsSkuæ³¨å†ŒchangeSkuäº‹ä»¶

```jsx
<GoodsSku
  @change-sku="changeSku(skuId)"
  :goods="goods"
  :sku-id="skuId"
></GoodsSku>

let currentSkuId = ''
const changeSku = (skuId: string) => {
  currentSkuId = skuId
  console.log('skuå‘ç”Ÿäº†å˜åŒ–', currentSkuId)
}
```

ï¼ˆ2ï¼‰cart-sku.vueç»„ä»¶ç¡®è®¤åä¼ å‡ºskuä¿¡æ¯

```jsx
<XtxButton
  type="primary"
  size="mini"
  style="margin-left:60px"
  @click="submit"
>
  ç¡®è®¤
</XtxButton>


// ç‚¹å‡»ç¡®è®¤çš„æ—¶å€™ï¼Œæäº¤skuä¿¡æ¯ç»™è´­ç‰©è½¦ç»„ä»¶
const emit = defineEmits<{
  (e: 'change', id: string): void
}>()

// ç‚¹å‡»ç¡®è®¤çš„æ—¶å€™ï¼Œæäº¤skuä¿¡æ¯ç»™è´­ç‰©è½¦ç»„ä»¶
const submit = () => {
  // ç»™è´­ç‰©è½¦ç»„ä»¶æ•°æ®çš„å‰æï¼šæœ‰skuä¿¡æ¯ï¼Œskuä¿¡æ¯å®Œæ•´ï¼Œskuä¸­çš„skuIdä¸èƒ½ç°æœ‰props.skuIdä¸€æ ·
  if (currentSkuId && currentSkuId !== props.skuId) {
    emit('change', currentSkuId)
    visible.value = false
  } else {
    Message({ type: 'warning', text: 'è¯·ä¿®æ”¹è§„æ ¼' })
  }
}
```

ï¼ˆ3ï¼‰cart/index.vueç»„ä»¶ç»™cark-sku.vueç»„ä»¶ç»‘å®šchangeäº‹ä»¶ï¼Œä¼ å…¥é»˜è®¤å€¼å’Œå½“å‰çš„å•†å“ä¿¡æ¯ã€‚

```ts
<!-- é€‰æ‹©è§„æ ¼ç»„ä»¶ -->
<CartSku
  @change="updateCartSku(item.skuId, $event)"
  :attrsText="item.attrsText"
  :skuId="item.skuId"
/>


const updateCartSku = async (oldSkuId: string, newSku: string) => {
  await cart.updateCartSku(oldSkuId, newSku)
  Message.success('ä¿®æ”¹å•†å“è§„æ ¼æˆåŠŸ')
}
```

ï¼ˆ4ï¼‰å†åœ¨actionsç§å®ç°é€»è¾‘ `src/store/modules/cart.ts`

> - äºæ²¡æœ‰ä¿®æ”¹è§„æ ¼çš„æ¥å£ã€‚é€šè¿‡åˆ é™¤æ—§å•†å“ï¼Œæ’å…¥æ–°å•†å“ï¼Œå®Œæˆä¿®æ”¹è§„æ ¼ã€‚

```ts
async updateCartSku(oldSkuId: string, newSku: string) {
  const oldGoods = this.list.find((item) => item.skuId === oldSkuId)!
  await request.delete('/member/cart', {
    data: {
      ids: [oldGoods.skuId]
    }
  })
  await request.post('/member/cart', {
    skuId: newSku,
    count: oldGoods.count
  })
  this.getCartList()
}
```

## é€€å‡ºç™»å½•-æ¸…ç©ºè´­ç‰©è½¦

è´­ç‰©è½¦æ¨¡å—ï¼š`src\store\modules\cart.ts`

```diff
const useCartStore = defineStore("cart", {
  // æ–¹æ³•
  actions: {
    ...
+    // æ¸…ç©ºè´­ç‰©è½¦
+    clearCart() {
+      // é€€å‡ºç™»å½•éœ€æ¸…ç©ºè´­ç‰©è½¦
+      this.list = [];
+    },
  },
});
```

ä¼šå‘˜ä¸­å¿ƒæ¨¡å—ï¼š`src\store\modules\user.ts`

```ts
logout() {
  this.profile = {} as Profile
  removeProfile()
  // æ¸…ç©ºè´­ç‰©è½¦æ•°æ®
  const { cart } = useStore()
  cart.clearCart()
},
```

# è´­ç‰©è½¦æ“ä½œ-æœªç™»å½•

## åŒºåˆ†æœªç™»å½•å’Œå·²ç™»å½•

ï¼ˆ1ï¼‰cartæ¨¡å—å¢åŠ è®¡ç®—å±æ€§isLogin

```ts
getters: {
  // ğŸ”‘ç™»å½•çŠ¶æ€
  isLogin(): boolean {
    const { user } = useStore()
    return !!user.profile.token
  }
},
```

ï¼ˆ2ï¼‰ä¿®æ”¹æ·»åŠ è´­ç‰©è½¦å’Œè·å–è´­ç‰©è½¦çš„é€»è¾‘

```ts
// æ·»åŠ è´­ç‰©è½¦
async addCart(skuId: string, count: number) {
  if (this.isLogin) {
    await request.post('/member/cart', {
      skuId,
      count
    })
    // é‡æ–°è·å–è´­ç‰©è½¦æ•°æ®
    this.getCartList()
  } else {
    console.log('æœ¬åœ°æ·»åŠ è´­ç‰©è½¦')
  }
},
// è·å–è´­ç‰©è½¦åˆ—è¡¨
async getCartList() {
  if (this.isLogin) {
    const res = await request.get<ApiRes<CartItem[]>>('/member/cart')
    this.list = res.data.result
  } else {
    console.log('è·å–æœ¬åœ°è´­ç‰©è½¦')
  }
},
```

## åŠ å…¥è´­ç‰©è½¦

> `æœ¬èŠ‚ç›®æ ‡:` å®ç°åŠ å…¥è´­ç‰©è½¦ä¸šåŠ¡ã€‚

**å®ç°æ­¥éª¤**

1. ç‚¹å‡»åŠ å…¥è´­ç‰©è½¦çš„æ—¶å€™ï¼Œä»å•†å“è¯¦æƒ…ä¸­æ”¶é›†è´­ç‰©è½¦å•†å“å±•ç¤ºæ‰€éœ€æ•°æ®
2. actions ä¸­å®Œæˆæ·»åŠ æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**è½åœ°ä»£ç **

å•†å“è¯¦æƒ…é¡µï¼š`src\views\goods\index.vue`

```ts
const addCart = async () => {
  if (!currentSkuId) {
    return Message.warning('è¯·é€‰æ‹©å®Œæ•´çš„å•†å“ä¿¡æ¯')
  }
  cart.addCart({
    // æœ¬åœ°æ·»åŠ 
    id: info.value.id,
    name: info.value.name,
    picture: info.value.mainPictures[0],
    price: info.value.price,
    count: count.value,
    skuId: currentSkuId,
    attrsText: '',
    selected: true,
    nowPrice: info.value.price,
    stock: info.value.inventory,
    isEffective: true,
  } as CartItem)

  Message.success('æ·»åŠ æˆåŠŸ')
}
```



ä¿®æ”¹åŠ å…¥è´­ç‰©è½¦çš„é€»è¾‘ï¼š`src/store/modules/cart.ts`

```ts
// æ·»åŠ è´­ç‰©è½¦
async addCart(data: CartItem) {
  if (this.isLogin) {
    const { skuId, count } = data
    await request.post('/member/cart', {
      skuId,
      count
    })
    // é‡æ–°è·å–è´­ç‰©è½¦æ•°æ®
    this.getCartList()
  } else {
    console.log('æœ¬åœ°æ·»åŠ è´­ç‰©è½¦')
    // 1. åˆ¤æ–­è´­ç‰©è½¦åˆ—è¡¨ä¸­æ˜¯å¦æœ‰è¯¥å•†å“æ•°æ®
    const goods = this.list.find((item) => item.skuId === data.skuId)
    if (goods) {
      // 2. å¦‚æœå•†å“å­˜åœ¨ï¼Œç›´æ¥æŠŠæ•°é‡åŠ èµ·æ¥
      goods.count += data.count
    } else {
      // 3. å¦‚æœå•†å“ä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ è¯¥å•†å“
      this.list.unshift(data)
    }
  }
},
```

## æ‹¼æ¥attrsText

```ts
const addCart = async () => {
  if (!currentSkuId) {
    return Message.warning('è¯·é€‰æ‹©å®Œæ•´çš„å•†å“ä¿¡æ¯')
  }
  // å½“å‰éœ€è¦æ·»åŠ çš„å•†å“çš„sku
  const sku = info.value.skus.find((item) => item.id === currentSkuId)!
  const attrsText = sku.specs
    .map((item) => item.name + ':' + item.valueName)
    .join(' ')
  // console.log(attrsText)
  cart.addCart({
    // æœ¬åœ°æ·»åŠ 
    id: info.value.id,
    name: info.value.name,
    picture: info.value.mainPictures[0],
    price: info.value.price,
    count: count.value,
    skuId: currentSkuId,
    attrsText: attrsText,
    selected: true,
    nowPrice: info.value.price,
    stock: info.value.inventory,
    isEffective: true,
  } as CartItem)

  Message.success('æ·»åŠ æˆåŠŸ')
}
```

## è´­ç‰©è½¦æ•°æ®æŒä¹…åŒ–

> `æœ¬èŠ‚ç›®æ ‡:` å®ç° `Pinia` è´­ç‰©è½¦åˆ—è¡¨çš„æŒä¹…åŒ–å­˜å‚¨ã€‚
>
> https://github.com/prazdevs/pinia-plugin-persistedstate

**å®ç°æ­¥éª¤**

ï¼ˆ1ï¼‰å®‰è£… `Pinia` æŒä¹…åŒ–å­˜å‚¨æ’ä»¶ï¼Œåœ¨æ¨¡å—ä¸­å¼€å¯æ’ä»¶åŠŸèƒ½å³å¯ã€‚

```bash
yarn add pinia-plugin-persistedstate
```

ï¼ˆ2ï¼‰åœ¨`main.ts`ä¸­

```ts
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)
```

ï¼ˆ3ï¼‰é€šè¿‡`persist`å¼€å¯è‡ªåŠ¨æŒä¹…åŒ–æ’ä»¶

```ts
const useCartStore = defineStore({
  id: 'cart',
  persist: {1
    key: 'rabbit-cart-92'
  },
})
```

## åˆ é™¤è´­ç‰©è½¦

> `æœ¬èŠ‚ç›®æ ‡:` å®ç°åˆ é™¤æ“ä½œã€‚

**å®ç°æ­¥éª¤**

- actions ä¸­å®Œæˆåˆ é™¤æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**è½åœ°ä»£ç **

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.ts`

```ts
// åˆ é™¤è´­ç‰©è½¦åˆ—è¡¨
async delCart(skuIds: string[]) {
  if (this.isLogin) {
    await request.delete('/member/cart', {
      data: {
        ids: skuIds
      }
    })
    this.getCartList()
  } else {
    this.list = this.list.filter((item) => !skuIds.includes(item.skuId))
  }
},
```

## é€‰ä¸­çŠ¶æ€åˆ‡æ¢&ä¿®æ”¹æ•°é‡

> `æœ¬èŠ‚ç›®æ ‡:` å®ç°å•†å“é€‰ä¸­çŠ¶æ€çš„åˆ‡æ¢å’Œä¿®æ”¹å•†å“æ•°é‡ã€‚

**å®ç°æ­¥éª¤**

- actions ä¸­å®Œæˆä¿®æ”¹æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**ä»£ç è½åœ°**

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.ts`

```ts
// ä¿®æ”¹è´­ç‰©è½¦å•†å“
async updateCart(
  skuId: string,
  data: { selected?: boolean; count?: number }
) {
  if (this.isLogin) {
    await request.put(`/member/cart/${skuId}`, data)
    // é‡æ–°è·å–æœ€æ–°è´­ç‰©è½¦åˆ—è¡¨
    this.getCartList()
  } else {
    const sku = this.effectiveList.find((item) => item.skuId === skuId)!
    if (data.selected !== undefined) sku.selected = data.selected
    if (data.count !== undefined) sku.count = data.count
  }
},
```

## å•†å“è§„æ ¼ä¿®æ”¹

ï¼ˆ1ï¼‰ä¿®æ”¹cart-sku.vueï¼Œç‚¹å‡»ç¡®å®šçš„æ—¶å€™ï¼Œè¦ä¼ é€’ä¸€ä¸ªå®Œæ•´skuå¯¹è±¡

```ts
const emit = defineEmits<{
  (e: 'change', sku: Sku): void
}>()
const submit = () => {
  // åˆ¤æ–­ï¼ŒcurrentSkuIdæœ‰å€¼å¹¶ä¸”å’ŒåŸæ¥çš„skuIdä¸èƒ½ç›¸ç­‰
  if (currentSkuId && currentSkuId !== props.skuId) {
    // å­ä¼ çˆ¶ï¼ŒæŠŠcurrentSkuIdä¼ å›å»
    const sku = goods.value.skus.find((item) => item.id === currentSkuId)
    console.log(sku)
    emit('change', sku as Sku)
  } else {
    Message.warning('å•†å“è§„æ ¼ä¸å®Œæ•´æˆ–è€…æ²¡å˜åŒ–')
  }
}
```

ï¼ˆ2ï¼‰ä¿®æ”¹cart/index.vueç»„ä»¶

```ts
<!-- è§„æ ¼ç»„ä»¶ -->
<CartSku
  :attrsText="item.attrsText"
  :skuId="item.skuId"
  @change="updateCartSku(item.skuId, $event)"
></CartSku>


const updateCartSku = async (oldSkuId: string, sku: Sku) => {
  // åº“å­˜  ä»·é’±   skuId
  await cart.updateCartSku(oldSkuId, sku)
  Message.success('ä¿®æ”¹è§„æ ¼æˆåŠŸ')
}
```

ï¼ˆ3ï¼‰ä¿®æ”¹storeä¸­actions

```ts
async updateCartSku(oldSkuId: string, sku: Sku) {
  if (this.isLogin) {
    // 1. å…ˆè·å–è€çš„å•†å“ä¿¡æ¯
    const oldSku = this.effectiveList.find(
      (item) => item.skuId === oldSkuId
    )
    // 2. å‘é€è¯·æ±‚åˆ é™¤æ—§çš„å•†å“
    await request.delete('/member/cart', {
      data: {
        ids: [oldSkuId],
      },
    })
    // 3. æ–°å¢å•†å“
    await request.post('/member/cart', {
      skuId: sku.id,
      count: oldSku?.count,
    })
    // 4. é‡æ–°æ¸²æŸ“
    this.getCartList()
  } else {
    // æ€è·¯ï¼š
    // 1. åˆ é™¤åŸæ¥çš„å•†å“
    const oldSku = this.effectiveList.find(
      (item) => item.skuId === oldSkuId
    )!
    this.delCart([oldSkuId])
    // 2. æ·»åŠ æ–°çš„å•†å“
    this.addCart({
      ...oldSku,
      skuId: sku.id,
      nowPrice: sku.price,
      price: sku.price,
      stock: sku.inventory,
      attrsText: sku.specs
        .map((item) => item.name + ':' + item.valueName)
        .join(' '),
    })
  }
},
```



## å…¨é€‰åˆ‡æ¢-æœ¬åœ°

> `æœ¬èŠ‚ç›®æ ‡:` å®ç°å•†å“é€‰ä¸­çŠ¶æ€çš„åˆ‡æ¢ã€‚

**å®ç°æ­¥éª¤**

- actions ä¸­å®Œæˆå…¨é€‰åˆ‡æ¢æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**ä»£ç è½åœ°**

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.ts`

```ts
async updateCartAllSelected(data: { selected: boolean; ids?: string[] }) {
  if (this.isLogin) {
    await request.put('/member/cart/selected', data)
    // è·å–è´­ç‰©è½¦åˆ—è¡¨
    this.getCartList()
  } else {
    this.list.forEach((item) => {
      item.selected = data.selected
    })
  }
},
```

## ä¼˜åŒ–-ä¸»åŠ¨æ›´æ–°æœ¬åœ°è´­ç‰©è½¦ä¿¡æ¯

> **æœ¬èŠ‚ç›®æ ‡ï¼š** æœªç™»å½•æƒ…å†µä¸‹ï¼Œè·å–æœ¬åœ°çš„è´­ç‰©è½¦æ•°æ®ï¼Œéœ€è¦æ›´æ–°å•†å“ä¿¡æ¯ã€‚
>
> åŸå› è§£é‡Šï¼šæœ¬åœ°å­˜å‚¨çš„åº“å­˜ä¿¡æ¯å’Œä»·æ ¼**ä¸æ˜¯æœåŠ¡å™¨æœ€æ–°çš„**ï¼Œæ‰€ä»¥éœ€**è¦ä¸»åŠ¨è·å–**æœ€æ–°å•†å“ä¿¡æ¯ã€‚

**å®ç°æ€è·¯**

1. è·å–è´­ç‰©è½¦åˆ—è¡¨çš„ action ä¸­ï¼Œ**æœªç™»å½•æƒ…å†µ** ä¸‹ä¸»åŠ¨æŸ¥è¯¢å•†å“åº“å­˜ä»·æ ¼ã€‚
2. è´­ç‰©è½¦çš„å•†å“åº“å­˜ä»·æ ¼ï¼Œæ›´æ–°æˆæœ€æ–°çš„åº“å­˜ä»·æ ¼ä¿¡æ¯ã€‚

**ä»£ç è½åœ°**

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.js`

```ts
// è·å–è´­ç‰©è½¦åˆ—è¡¨
async getCartList() {
  if (this.isLogin) {
    const res = await request.get<ApiRes<CartItem[]>>('/member/cart')
    this.list = res.data.result
  } else {
    this.list.forEach(async (cartItem) => {
      const { skuId } = cartItem
      // æ ¹æ® skuId è·å–æœ€æ–°å•†å“ä¿¡æ¯
      const res = await request.get<ApiRes<CartItem>>(
        `/goods/stock/${skuId}`
      )
      // ä¿å­˜æœ€æ–°å•†å“ä¿¡æ¯
      const lastCartInfo = res.data.result
      // æ›´æ–°å•†å“ç°ä»·
      cartItem.nowPrice = lastCartInfo.nowPrice
      // æ›´æ–°å•†å“åº“å­˜
      cartItem.stock = lastCartInfo.stock
      // æ›´æ–°å•†å“æ˜¯å¦æœ‰æ•ˆ
      cartItem.isEffective = lastCartInfo.isEffective
    })
  }
},
```

# ä¸¤ä¸ªç‰ˆæœ¬è´­ç‰©è½¦åˆå¹¶

## ç™»å½•ååˆå¹¶è´­ç‰©è½¦

`æœ¬èŠ‚ç›®æ ‡:` ç™»å½•åæŠŠæœ¬åœ°çš„è´­ç‰©è½¦æ•°æ®åˆå¹¶åˆ°åç«¯æœåŠ¡

> æœ¬åœ°å·²ç»å­˜å¥½çš„æ‰€æœ‰è´­ç‰©è½¦åˆ—è¡¨æ•°æ®éƒ½éœ€è¦å’ŒæœåŠ¡å™¨åˆå¹¶ä¸€ä¸‹ã€‚

**å®ç°æ€è·¯**

1. ç¼–å†™åˆå¹¶è´­ç‰©è½¦çš„ `action` å‡½æ•° ï¼ˆå°†å¯¹äºè´­ç‰©è½¦çš„å¤„ç†ï¼Œç»Ÿä¸€åˆ° `Pinia` ä¸­ï¼‰
2. è°ƒç”¨åˆå¹¶è´­ç‰©è½¦çš„ `action` å‡½æ•° ï¼ˆæ€è€ƒï¼šåœ¨å“ªè°ƒç”¨ï¼Ÿç­”ï¼šç™»å½•å®Œæˆåï¼‰

**è½åœ°ä»£ç **

1ï¼‰ç¼–å†™åˆå¹¶è´­ç‰©è½¦çš„ actions å‡½æ•°

è´­ç‰©è½¦æ¨¡å—ï¼š`src/store/modules/cart.ts`

```ts
// åˆå¹¶è´­ç‰©è½¦
async mergeLocalCart() {
  const data = this.list.map(({ skuId, selected, count }) => ({
    skuId,
    selected,
    count
  }))
  await request.post('/member/cart/merge', data)
  // åˆå¹¶æˆåŠŸï¼Œé‡æ–°è·å–è´­ç‰©è½¦åˆ—è¡¨
  this.getCartList()
}
```

2ï¼‰åœ¨ç™»å½•å®ŒæˆåŠŸåï¼Œè°ƒç”¨åˆå¹¶è´­ç‰©è½¦ `actions` å‡½æ•°

ç”¨æˆ·æ¨¡å—

```ts
const login = async () => {
  const res = await validate()
  if (type.value === 'account') {
    // è´¦å·ç™»å½•
    if (res.errors.account || res.errors.password || res.errors.isAgree) return
    await user.login(account.value, password.value)
  } else {
    // éªŒè¯ç ç™»å½•
    if (res.errors.mobile || res.errors.code || res.errors.isAgree) return
    await user.mobileLogin(mobile.value, code.value)
  }

  // ç™»å½•æˆåŠŸåï¼Œåˆå¹¶è´­ç‰©è½¦
  const { cart } = useStore()
  cart.mergeLocalCart()
  Message.success('ç™»å½•æˆåŠŸ')
  router.push('/')
}

```

